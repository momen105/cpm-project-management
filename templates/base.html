<!-- templates/base.html -->
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CPM</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

   <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />



  <style>
    body {
      background-color: #e3f2fd;
    }
    .nav-link.active {
      border-bottom: 2px solid white;
    }
    .user-profile {
      border-radius: 50%;
      height: 30px;
    }
    .navbar{
        background-color: #1565c0;
    }
    .dropdown img{
        border: 1px solid;
    }
  
    .task-list {
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    overflow: hidden;
  }

  .task-list thead tr:first-child th:first-child {
    border-top-left-radius: 12px;
  }

  .task-list thead tr:first-child th:last-child {
    border-top-right-radius: 12px;
  }

  .task-list th, .task-list td {
    padding: 12px 16px;
    vertical-align: middle;
    /* border: 1px solid #dee2e6; */
    background-color: #fff;
  }

  .task-list thead th {
    background-color: #f8f9fa;
  }
    
  .mermaid {
    text-align: center;
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }



    /* -------------------Network Diagram----------------- */

    .diagram {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .activity {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      grid-template-rows: 1fr 1fr;
      width: 100px;
      height: 60px;
      border: 2px solid red;
      text-align: center;
      font-family: Arial, sans-serif;
      position: relative;
    }

    .activity > div {
      border: 1px solid #ccc;
      padding: 2px;
      font-size: 12px;
    }

    .activity .name {
      grid-column: 2;
      grid-row: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: red;
    }

    .activity.critical {
      background-color: #ffecec;
    }

    .arrow {
      width: 40px;
      height: 2px;
      background: black;
      align-self: center;
    }



    /* --------------------Project Schedule Diagram------------------------- */
  #diagram {
    position: relative;
    width: 80%;
    min-height: 400px;
    margin: auto;
    background: white;
    /* border: 1px solid #ccc; */
  }
  .activity-box {
    position: absolute;
    width: 100px;
    height: 70px;
    border: 2px solid #ccc;
    border-radius: 8px;
    background: #fff;
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    grid-template-rows: 1fr 1fr;
    text-align: center;
    font-size: 14px;
    cursor: default;
    transition: box-shadow 0.3s ease;
    
  }
  .activity-box:hover {
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .activity-box.critical {
    border-color: #d33;
    background: #ffecec;
    color: #a00;
    font-weight: bold;
    
  }
  .blue-text {
    color: #1565c0;
    padding: 4px;
    font-size: 13px;
  }
  .activity-name {
    grid-column: 2;
    grid-row: 1 / span 2;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #d33;
  }

      
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark ">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">CPM</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Projects</a></li>
        <li class="nav-item"><a class="nav-link active" href="#">Single Phase Project 01</a></li>
      </ul>
      <div class="d-flex align-items-center">
    <div class="dropdown">
        <a href="#" class="d-flex align-items-center text-white text-decoration-none" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="{% static 'image/user.webp' %}" alt="profile" width="32" height="32" class="rounded-circle me-2 ">
            <i class="fa-solid fa-chevron-down " ></i>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownUser">
            <li>
            <a class="dropdown-item d-flex align-items-center" href="#">
                 Logout
            </a>
            </li>
        </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Content Block -->
<div class="container my-4">
  {% block component %}{% endblock %}
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leader-line@1.0.7/leader-line.min.js"></script>

<!----------------------- Network Diagram ----------------------->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false });

  async function loadDiagram() {
    const diagram = `
      graph LR
        A(( A ))
        B((B))
        C((C))
        D((D))
        E((E))
        F((F))
        G((G))
        H((H))
        I((I))
        A --> B
        A --> C
        B --> D
        B --> E
        C --> F
        D --> G
        E --> G
        F --> H
        G --> I
        H --> I
    `;

    const el = document.getElementById("mermaid-diagram");
    el.innerHTML = diagram;

    await mermaid.run({ nodes: [el] }); 
    // Slight delay to ensure SVG is rendered
    setTimeout(addNodeClickHandlers, 100);
  }

  function addNodeClickHandlers() {
      const nodeData = {
    A: { title: "Confirm lead speaker & topic", description: "–", duration: "10 days" },
    B: { title: "Prepare brochure", description: "A", duration: "15 days" },
    C: { title: "Send letters to speakers", description: "A", duration: "3 days" },
    D: { title: "Get confirmation from speakers", description: "B", duration: "8 days" },
    E: { title: "Send letters to participants", description: "B", duration: "7 days" },
    F: { title: "Obtain travel plans from speakers", description: "C", duration: "6 days" },
    G: { title: "Arrange for accommodation for speakers", description: "D, E", duration: "10 days" },
    H: { title: "Get handouts from speakers", description: "E, F", duration: "15 days" },
    I: { title: "Finalize registrations", description: "G, H", duration: "5 days" },
  };

  const popup = document.getElementById("node-popup");

  document.querySelectorAll("#mermaid-diagram .node").forEach(node => {
    node.style.cursor = 'pointer';
    node.addEventListener("click", event => {
      const dataId = node.getAttribute("data-id");
      const data = nodeData[dataId];

      if (data) {
        // Fill popup
        document.getElementById("popup-title").innerText = data.title;
        document.getElementById("popup-desc").innerText = `Depends on: ${data.description}`;
        document.getElementById("popup-duration").innerText = data.duration;

        // Position near the click
        const rect = node.getBoundingClientRect();
        popup.style.top = `${rect.top + window.scrollY + 20}px`;
        popup.style.left = `${rect.left + window.scrollX + 20}px`;

        // Show popup
        popup.style.display = "block";
      }
    });
  });

  // Optional: Hide the popup if user clicks outside
  document.addEventListener("click", function (event) {
    if (!document.getElementById("node-popup").contains(event.target) &&
        !event.target.closest(".node")) {
      popup.style.display = "none";
    }
  });
    
  }
  window.addEventListener("DOMContentLoaded", loadDiagram);
</script>

<!--------------------- Project Schedule Diagram ---------------->
<script>

  
  // Sample API data with positions (you can adjust positions or calculate dynamically)
    const activities = [
      { id: 'A', name: 'A', es: 0, ef: 10, ls: 0, lf: 10, slack: 0, duration: 10, critical: true },
      { id: 'B', name: 'B', es: 10, ef: 25, ls: 10, lf: 25, slack: 0, duration: 15, critical: true },
      { id: 'C', name: 'C', es: 10, ef: 13, ls: 23, lf: 26, slack: 13, duration: 3, critical: false },
      { id: 'D', name: 'D', es: 25, ef: 33, ls: 29, lf: 37, slack: 4, duration: 8, critical: false },
      { id: 'E', name: 'E', es: 25, ef: 32, ls: 25, lf: 32, slack: 0, duration: 7, critical: true },
      { id: 'F', name: 'F', es: 13, ef: 19, ls: 26, lf: 32, slack: 13, duration: 6, critical: false },
      { id: 'G', name: 'G', es: 33, ef: 43, ls: 37, lf: 47, slack: 4, duration: 10, critical: false },
      { id: 'H', name: 'H', es: 32, ef: 47, ls: 32, lf: 47, slack: 0, duration: 15, critical: true },
      { id: 'I', name: 'I', es: 47, ef: 52, ls: 47, lf: 52, slack: 0, duration: 5, critical: true },
    ];

  // Connections between activities (from -> to)
  const connections = [
    ['A', 'B'],
    ['A', 'C'],
    ['B', 'D'],
    ['B', 'E'],
    ['C', 'F'],
    ['D', 'G'],
    ['E', 'G'],
    ['F', 'H'],
    ['G', 'I'],
    ['H', 'I'],
  ];


  const diagram = document.getElementById('diagram');

    // Create a dagre graph
    const g = new dagre.graphlib.Graph();
    g.setGraph({
      rankdir: 'LR', // Left to Right layout
      marginx: 20,
      marginy: 20,
    });
    g.setDefaultEdgeLabel(() => ({}));

    // Add nodes with width & height
    activities.forEach(({ id }) => {
      g.setNode(id, { width: 100, height: 80 });
    });

    // Add edges
    connections.forEach(([fromId, toId]) => {
      g.setEdge(fromId, toId);
   
    });

    // Compute the layout
    dagre.layout(g);

    // Assign x,y from dagre to activities
    activities.forEach(act => {
      const node = g.node(act.id);
      act.x = node.x - 50; // center x minus half width
      act.y = node.y - 40; // center y minus half height
    });

  // Render activity boxes
  activities.forEach(({ id, name, es, ef, ls, lf, slack, critical, x, y }) => {
    const box = document.createElement('div');
    box.className = 'activity-box' + (critical ? ' critical' : '');
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.id =  id;

    box.innerHTML = `
      <div class="blue-text">${es}</div>
      <div class="activity-name">${name}</div>
      <div class="blue-text">${ef}</div>
      <div>${ls}</div>
      <div>${lf}</div>
    `;
    
  diagram.appendChild(box);


  window.onload = function () {
      

  connections.forEach(([fromId, toId]) => {
        const from = document.getElementById(fromId);
        const to = document.getElementById(toId);
        if (from && to) {
          new LeaderLine(from, to, {
              color: 'orange',
              size: 2,
              startSocketGravity: [0, 0],
              endSocketGravity: [0, 0],
              endPlug: 'arrow3',
              path: 'fluid',
              dash: { animation: true }
          });
        } else {
          console.warn(`Missing element: ${fromId} or ${toId}`);
        }
      });

   
   
  setTimeout(() => {
    document.querySelectorAll('svg.leader-line').forEach((svg) => {
      ['top'].forEach((prop) => {
        const value = parseFloat(svg.style[prop]);
        if (!isNaN(value)) {
          svg.style[prop] = `${value * 1.03}px`;
        }
      });
    });
  }, 100); 
};

});


  const psdpopup = document.getElementById("psd-popup");

  function addPsdNodeHoverHandlers() {
    const nodeData = {
      A: { title: "Confirm lead speaker & topic", description: "–", duration: "10 days" },
      B: { title: "Prepare brochure", description: "A", duration: "15 days" },
      C: { title: "Send letters to speakers", description: "A", duration: "3 days" },
      D: { title: "Get confirmation from speakers", description: "B", duration: "8 days" },
      E: { title: "Send letters to participants", description: "B", duration: "7 days" },
      F: { title: "Obtain travel plans from speakers", description: "C", duration: "6 days" },
      G: { title: "Arrange for accommodation for speakers", description: "D, E", duration: "10 days" },
      H: { title: "Get handouts from speakers", description: "E, F", duration: "15 days" },
      I: { title: "Finalize registrations", description: "G, H", duration: "5 days" },
    };

    document.querySelectorAll("#diagram .activity-box").forEach(node => {
      node.style.cursor = 'pointer';

      node.addEventListener("mouseover", event => {
        const dataId = node.id;
        const data = nodeData[dataId];
        
        if (data) {
          console.log(data.title)
          document.getElementById("psdpopup-title").innerText = data.title;
          document.getElementById("psdpopup-desc").innerText = `Depends on: ${data.description}`;
          document.getElementById("psdpopup-duration").innerText = data.duration;

          const rect = node.getBoundingClientRect();
          psdpopup.style.top = `${rect.top + window.scrollY + 20}px`;
          psdpopup.style.left = `${rect.left + window.scrollX + 20}px`;
          psdpopup.style.display = "block";
        }
      });

      node.addEventListener("mouseout", () => {
        psdpopup.style.display = "none";
      });
    });
  }

  document.addEventListener("DOMContentLoaded", addPsdNodeHoverHandlers);
</script>



<!--------------- Critical Path ---------------------------------->
<script>
 
  const CriticalPath = ['A', 'B', 'E', 'H', 'I'];
  const duration = "52 days";
  const container = document.getElementById("critical-path");

  CriticalPath.forEach((letter, index) => {
    // Create span for the letter
    const span = document.createElement("span");
    span.textContent = letter;
    span.style.color = "darkred";
    span.style.fontSize = "30px"; 
    span.style.fontWeight = "bold";
    span.style.margin = "0 5px";
    container.appendChild(span);

    // Add arrow if not the last letter
    if (index < CriticalPath.length - 1) {
      const arrow = document.createElement("span");
      arrow.textContent = "→";
      arrow.style.color = "darkred";
      arrow.style.fontSize = "40px"; 
      arrow.style.margin = "0 5px";
      container.appendChild(arrow);
    }
  });
  const durationSpan = document.createElement("span");
  durationSpan.textContent = `(${duration})`;
  durationSpan.style.color = "gray";
  durationSpan.style.marginLeft = "10px";
  durationSpan.style.fontWeight = "bold";
  container.appendChild(durationSpan);
    


</script>


</body>
</html>
