<!-- templates/task_details.html -->
{% extends 'base.html' %}

{% block component %}
<h3 class="mb-3">Task Details</h3>
<div class="">
  <table class="task-list ">
    <thead class="table-light">
      <tr>
        <th>Task Activity</th>
        <th>Description</th>
        <th>Immediate Predecessor</th>
        <th>Duration (days)</th>
        <th>Start date</th>
        <th>Finish date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for item in tasks %}
      <tr>
        <td>{{item.name}}</td>
        <td>{{item.description}}</td>
        <td>{% for i in item.predecessors.all %}
          {{i.name}},
          {% endfor %}
        </td>
        <td>{{item.duration}}</td>
        <td>{{item.start_date}}</td>
        <td>{{item.finish_date}}</td>
        <td >
                <a class="action-button me-1 btn-edit" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editTaskModal" 
                  data-id="{{item.id}}" 
                  data-name="{{item.name}}" 
                  data-description="{{item.description}}" 
                  data-duration="{{item.duration}}" 
                  data-start="{{item.start_date}}" 
                  data-finish="{{item.finish_date}}" 
                  data-predecessors="{% for p in item.predecessors.all %}{{p.id}},{% endfor %}">
                    <i class="fa-solid fa-pen-to-square"></i>
                </a>
                <a  class="action-button btn-delete" data-id="{{item.id}}">
                  <i class="fa-solid fa-trash"></i>
              </a>

            </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<button class="btn custom-button mt-3" data-bs-toggle="modal" data-bs-target="#addTaskModal">+ Add Data</button>


<h4 class="mt-5">Network Diagram</h4>
<div id="mermaid-diagram" class="network-mermaid">
  Loading...
</div>
<!-- Task Details Modal -->
<div id="node-popup" style="position: absolute; display: none; z-index: 1000;" class="card shadow-sm p-3 bg-white rounded border">
  <h6 id="popup-title" class="mb-2">Task Title</h6>
  <p id="popup-desc" class="mb-1 text-muted" style="font-size: 0.9em;"></p>
  <p class="mb-0"><strong>Duration:</strong> <span id="popup-duration"></span></p>
</div>

<br>
<h4>Project Schedule Diagram</h4>
<div class="mermaid-schedule">
  <div id="scheduleDiagram"></div>

</div>
<div id="psd-popup" style="border-radius: 5px; display:none; position:absolute; background:#fff; padding:10px; border:1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index:1000;">
  <h4 id="psdpopup-title"></h4>
  <p id="psdpopup-desc"></p>
  <p id="psdpopup-duration"></p>
</div>

<br>
<h4>Critical Path <span style="font-size: 10px;">(critical path nodes have no slack)</span></h4>
<div  class="mermaid-schedule">
  <div id="critical-path">

  </div>
</div>

<br>
<h4>Tabular Form</h4>
<table class="task-list ">
    <thead class="table-light">
      <tr>
        <th>Task Activity</th>
        <th>Description</th>
        <th>ES (Earliest Start)</th>
        <th>EF (Earliest Finish)</th>
        <th>LS (Latest Start)</th>
        <th>Lf (Latest Finish)</th>
        <th>Slack (LS - ES) or (LF - EF)</th>
      </tr>
    </thead>
    <tbody>
      {% for item in activities %}
      <tr>
        <td>{{item.name}}</td>
        <td>{{item.description}}</td>
        <td>{{item.es}}</td>
        <td>{{item.ef}}</td>
        <td>{{item.ls}}</td>
        <td>{{item.lf}}</td>

        <td>{{item.slack}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

<br>
<h4>Gantt Chart</h4>
<div class="mermaid-schedule">
  <canvas id="ganttChart" width="1000" height="400"></canvas>
</div>


<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog  modal-lg">
    <div class="modal-content">
      <form method="POST" action="{% url 'project_details' id=project.id   %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addTaskModalLabel">New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
              <input type="hidden" class="form-control" id="Project" name="project" value="{{project.id}}"></input>
            <div class="col-6">
              <div class="mb-3">
                <label for="Name" class="form-label">Task Activity</label>
                <input type="text" class="form-control" id="Name" name="name" required></input>
              </div>
              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label for="duration" class="form-label">Duration</label>
                <input type="number" class="form-control" id="duration" name="duration"  required></input>
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="start_date" name="start_date"  required></input>
              </div>
              <div class="mb-3">
                <label for="finish_date" class="form-label">Finish Date</label>
                <input type="date" class="form-control" id="finish_date" name="finish_date"  required></input>
              </div>
              <div class="mb-3">
              
                <label for="Predecessors" class="form-label">Predecessors</label>
                 <select name="predecessors" id="Predecessors" class="form-select" multiple>
                    
                    {% for item in tasks %}
                      
                        <option value="{{ item.id }}">{{ item.name }}</option>
                    {% endfor %}
                </select>


              </div>

            </div>

          </div>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add Project</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog  modal-lg">
    <div class="modal-content">
      <form method="POST" id="editTaskForm" action="{% url 'project_details' id=project.id   %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
       
        <div class="modal-body">
           <div class="row">
          <div class="col-6">
             <input type="hidden" id="edit-task-id" name="task_id">

          <div class="mb-3">
            <label for="edit-name" class="form-label">Task Activity</label>
            <input type="text" class="form-control" id="edit-name" name="name" required>
          </div>

          <div class="mb-3">
            <label for="edit-description" class="form-label">Description</label>
            <textarea class="form-control" id="edit-description" name="description" rows="3" required></textarea>
          </div>

          <div class="mb-3">
            <label for="edit-duration" class="form-label">Duration</label>
            <input type="number" class="form-control" id="edit-duration" name="duration" required>
          </div>
            
          </div>
          <div class="col-6">
            
          <div class="mb-3">
            <label for="edit-start-date" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="edit-start-date" name="start_date" required>
          </div>

          <div class="mb-3">
            <label for="edit-finish-date" class="form-label">Finish Date</label>
            <input type="date" class="form-control" id="edit-finish-date" name="finish_date" required>
          </div>

          <div class="mb-3">
            <label for="edit-predecessors" class="form-label">Predecessors</label>
            <select name="predecessors" id="edit-predecessors" class="form-select" multiple>
              {% for item in tasks %}
                <option value="{{ item.id }}">{{ item.name }}</option>
              {% endfor %}
            </select>
          </div>

          </div>

        </div>

         

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Update Task</button>
        </div>
      </form>
    </div>
  </div>
</div>


{% endblock %}

{% block script %}


<script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js"></script>

<!----------------------- Network Diagram ----------------------->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  const projectId = "{{ project.id }}";

  document.addEventListener("DOMContentLoaded", async () => {
    
    const res = await fetch(`/network-diagram/${projectId}/`);
    const data = await res.json();
   
    mermaid.initialize({ startOnLoad: false });

    const el = document.getElementById("mermaid-diagram");
    el.innerHTML = data.diagram;
  
    await mermaid.run({ nodes: [el] }); 
    setTimeout(addNodeClickHandlers, 100);
    
    function addNodeClickHandlers() {
    const nodeData = data.nodes
    const popup = document.getElementById("node-popup");
    
    document.querySelectorAll("#mermaid-diagram .node").forEach(node => {
      node.style.cursor = 'pointer';
      node.addEventListener("click", event => {
        const dataId = node.getAttribute("data-id");
        const data = nodeData[dataId];
  
        if (data) {
          // Fill popup
          document.getElementById("popup-title").innerText = data.title;
          document.getElementById("popup-desc").innerText = `Depends on: ${data.description}`;
          document.getElementById("popup-duration").innerText = data.duration;
  
          // Position near the click
          const rect = node.getBoundingClientRect();
          popup.style.top = `${rect.top + window.scrollY + 20}px`;
          popup.style.left = `${rect.left + window.scrollX + 20}px`;
  
          // Show popup
          popup.style.display = "block";
        }
      });
    });
  
    // Optional: Hide the popup if user clicks outside
    document.addEventListener("click", function (event) {
      if (!document.getElementById("node-popup").contains(event.target) &&
          !event.target.closest(".node")) {
        popup.style.display = "none";
      }
    });
      
    }
  });


  
</script>


<!--------------------- Project Schedule Diagram ---------------->
<script>
 const project_Id = "{{ project.id }}";
  const diagram = document.getElementById('scheduleDiagram');
  const container = document.getElementById("critical-path");

  document.addEventListener("DOMContentLoaded", async () => {
    
    const res = await fetch(`/schedule-diagram/${project_Id}/`);
    const schedule_data = await res.json();
    const activities = schedule_data.activities;
    const connections = schedule_data.connections;
    const diagram_height = [];
  

  const g = new dagre.graphlib.Graph();
  g.setGraph({ rankdir: 'LR', marginx: 20, marginy: 20 });
  g.setDefaultEdgeLabel(() => ({}));

  activities.forEach(({ id }) => {
    g.setNode(id, { width: 100, height: 80 });
  });

  connections.forEach(([fromId, toId]) => {
    g.setEdge(fromId, toId);
  });

  dagre.layout(g);

  activities.forEach(act => {
    const node = g.node(act.id);
    act.x = node.x - 50;
    act.y = node.y - 40;
    diagram_height.push(act.y);
  });

  // Render all nodes
  activities.forEach(({ id, name, es, ef, ls, lf, slack, critical, x, y }) => {
    const box = document.createElement('div');
    box.className = 'activity-box' + (critical ? ' critical' : '');
    box.style.left = x + 'px';
    box.style.top = y + 'px';
    box.id = id;

    if (id === 'Start') {
      box.innerHTML = `<div class="activity-name">Start</div>`;
      box.classList.add('start-node');
    } else if (id === 'End') {
      box.innerHTML = `<div class="activity-name">End</div>`;
      box.classList.add('end-node');
    } else {
      box.innerHTML = `
        <div class="blue-text">${es}</div>
        <div class="activity-name">${name}</div>
        <div class="blue-text">${ef}</div>
        <div>${ls}</div>
        <div>${lf}</div>
      `;
    }

    diagram.appendChild(box);
  });

  const maxHeight = Math.max(...diagram_height);
  diagram.style.height = `${maxHeight + 100}px`;

  // ✅ Define and then call
  const psdpopup = document.getElementById("psd-popup");

  function addPsdNodeHoverHandlers() {
    const nodeData = schedule_data.node_data;

    document.querySelectorAll("#scheduleDiagram .activity-box").forEach(node => {
      node.style.cursor = 'pointer';

      node.addEventListener("mouseover", event => {
        const dataId = node.id;
        const data = nodeData[dataId];

        if (data) {
          document.getElementById("psdpopup-title").innerText = data.title;
          document.getElementById("psdpopup-desc").innerText = `Depends on: ${data.description}`;
          document.getElementById("psdpopup-duration").innerText = `Duration: ${data.duration}`;

          const rect = node.getBoundingClientRect();
          psdpopup.style.top = `${rect.top + window.scrollY + 20}px`;
          psdpopup.style.left = `${rect.left + window.scrollX + 20}px`;
          psdpopup.style.display = "block";
        }
      });

      node.addEventListener("mouseout", () => {
        psdpopup.style.display = "none";
      });
    });
  }

  // ✅ Call after nodes are in DOM
  addPsdNodeHoverHandlers();

  // Draw lines
  connections.forEach(([fromId, toId]) => {
    const from = document.getElementById(fromId);
    const to = document.getElementById(toId);
    if (from && to) {
      new LeaderLine(from, to, {
        color: 'orange',
        size: 2,
        startSocketGravity: [0, 0],
        endSocketGravity: [0, 0],
        endPlug: 'arrow3',
        path: 'fluid',
        dash: { animation: true }
      });
    }
  });



  // <!--------------- Critical Path ---------------------------------->
    
    const CriticalPath = schedule_data.critical_tasks;
    const duration = schedule_data.critical_path_duration;
    

    CriticalPath.forEach((letter, index) => {
      // Create span for the letter
      const span = document.createElement("span");
      span.textContent = letter;
      span.style.color = "darkred";
      span.style.fontSize = "30px"; 
      span.style.fontWeight = "bold";
      span.style.margin = "0 5px";
      container.appendChild(span);

      // Add arrow if not the last letter
      if (index < CriticalPath.length - 1) {
        const arrow = document.createElement("span");
        arrow.textContent = "→";
        arrow.style.color = "darkred";
        arrow.style.fontSize = "40px"; 
        arrow.style.margin = "0 5px";
        container.appendChild(arrow);
      }
    });
    const durationSpan = document.createElement("span");
    durationSpan.textContent = `(${duration})`;
    durationSpan.style.color = "gray";
    durationSpan.style.marginLeft = "10px";
    durationSpan.style.fontWeight = "bold";
    container.appendChild(durationSpan);
      


  });
 
</script>




<!-- ---------------------------Gantt Chart--------------------------->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const project_id = "{{ project.id }}";
  function waitForCanvasAndRenderChart() {
  const interval = setInterval(async () => {
    const canvas = document.getElementById('ganttChart');
    if (canvas) {
      clearInterval(interval);
      const ctx = canvas.getContext('2d');

      const gantt_res = await fetch(`/gantt-chart/${project_id}/`);
      const res_data = await gantt_res.json();

      const data = {
        labels: res_data.labels,
        datasets: [{
          label: 'Tasks',
          data: res_data.data,
          backgroundColor: 'rgb(71, 145, 219)',
          borderColor: 'rgb(71, 145, 219)',
          borderWidth: 1,
          barThickness: 20
        }]
      };

      const config = {
        type: 'bar',
        data,
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              position: 'top',
              min: 0,
              max: 50,
              ticks: { stepSize: 4 },
              grid: { color: '#bbdefb' }
            },
            y: { grid: { display: false } }
          }
        }
      };

      new Chart(ctx, config);
    }
  }, 200);
}

document.addEventListener("DOMContentLoaded", waitForCanvasAndRenderChart);
</script>



<script>
  $(document).ready(function() {
    $('#Predecessors').select2({
      placeholder: "Select predecessors",
      allowClear: true
    });
  });
</script>

<script>
  function formatDateForInput(dateStr) {
    const date = new Date(dateStr); // JS Date object
    // yyyy-mm-dd ফরম্যাটে convert
    return date.toISOString().slice(0, 10);
}

  $(document).on("click", ".btn-edit", function () {
    let id = $(this).data("id");
    let name = $(this).data("name");
    let description = $(this).data("description");
    let duration = $(this).data("duration");
   
    let start = formatDateForInput($(this).data("start"));
    let finish = formatDateForInput($(this).data("finish"));

    let predecessors = $(this).data("predecessors").toString().split(",").filter(Boolean);

    $("#edit-task-id").val(id);
    $("#edit-name").val(name);
    $("#edit-description").val(description);
    $("#edit-duration").val(duration);
    $("#edit-start-date").val(moment(start, "DD-MM-YYYY").format("YYYY-MM-DD"));
    $("#edit-finish-date").val(moment(finish, "DD-MM-YYYY").format("YYYY-MM-DD"));

    $("#edit-predecessors").val(predecessors).trigger("change");
    $('#edit-predecessors').select2({
      placeholder: "Select predecessors",
      allowClear: true
    });

});
</script>
<script>


    document.querySelectorAll(".btn-delete").forEach(button => {
    button.addEventListener("click", function(){
        let taskID = this.getAttribute("data-id");

        Swal.fire({
            title: "Are you sure?",
            text: "This will permanently delete the task!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/details/${taskID}/`, {
                    method: "DELETE",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                }).then(res => res.json())
                .then(data => {
                    if(data.success){
                        Swal.fire("Deleted!", "Project has been deleted.", "success")
                        .then(() => location.reload());
                    }
                });
            }
        })
    });
});
</script>
{% endblock %}